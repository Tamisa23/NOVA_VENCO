<!DOCTYPE html>
<html lang="th">
<head>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="/DOAU/DOAU.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wdth,wght@75..100,500&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DOAU-P1</title>
  <link rel="stylesheet" href="/DOAU/DOAU-P1.css">
</head>
<body>
  <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á -->
  <div class="BG">
    <a><img src="/image/DOAU/P1/BG.jpg"></a>
    <a><img src="/image/DOAU/P1/CDU.png"></a>
    <a><img src="/image/DOAU/P1/DG.png"></a>
    <a><img src="/image/DOAU/P1/SETTING.png"></a>
    <a><img src="/image/DOAU/P1/ST-BG.png"></a>
    <a href="/HOME/index.html" class="linkhome"></a>
  </div>
  <div class="line">
    <a><img src="/image/DOAU/P1/LINE.png"></a>
  </div>
  <div class="st">
    <a><img src="/image/DOAU/P1/ST-BG2.png"></a>
  </div>
  <div class="gif-ebm">
    <a><img id="ebm_gif" src="/image/DOAU/P1/GIF/GIF-EBM-N4.gif"></a>
  </div>
  <div class="gif-uv">
    <a><img id="UV_ON" src="/image/DOAU/P1/GIF/GIF-UV-N4.gif"></a>
  </div>
  <div class="gif-z">
    <a><img id="sa_gif" src="/image/DOAU/P1/GIF/GIF-Z-N4.gif"></a>
  </div>
  <div class="oa-t-container">
  <div id="OA_T" class="oa-t-value">0.0</div>
</div>
<div class="oa-h-container">
  <div id="OA_H" class="oa-h-value">0.0</div>
</div>
<div class="coil-container">
  <div id="Lev_Coil_T" class="coil-value">0.0</div>
</div>
<div class="airflow-container">
  <div class="airflow-value">NORMAL</div>
</div>
<div class="sa-t-container">
  <div id="SA_T" class="sa-t-value">0.0</div>
</div>
<div class="sa-h-container">
  <div id="SA_H"class="sa-h-value">0.0</div>
</div>
<div class="filter-container">
  <div class="filter-value">NORMAL</div>
</div>
<div class="valve-container">
  <div id="DXVALVE" class="valve-value">0.0</div>
</div>
<div class="dpt-container">
  <div class="dpt-value">0.0</div>
</div>
<div class="smoke-container">
  <div class="smoke-value">NORMAL</div>
</div>
<div class="za-st-container">
  <div id="sa_st" class="za-st-value">OFF</div>
</div>
<div class="za-speed-container">
  <div id="AC_SP_ZA" class="za-speed-value">0.0</div>
</div>
<div class="ebm-st-container">
  <div id="ebm_st" class="ebm-st-value">OFF</div>
</div>
<div class="ebm-speed-container">
  <div id="AC_SP_EBM" class="ebm-speed-value">0.0</div>
</div>
</body>

<script>
  // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MQTT Broker ‡∏ú‡πà‡∏≤‡∏ô WebSockets
const mqttClient = mqtt.connect("wss://2217876f209d4a73af014e541592ee16.s1.eu.hivemq.cloud:8884/mqtt", {
    username: "Venco",
    password: "12345678Venco",
    rejectUnauthorized: false
});

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
mqttClient.on("connect", function () {
    console.log("‚úÖ MQTT Connected!");
    mqttClient.subscribe("/edge/DOAU/+/rtg", function (err) {
        if (!err) {
            console.log("‚úÖ Subscribed to RTG topic");
        }
    });
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï DOM
function updateElement(id, value) {
    let element = document.getElementById(id);
    if (element && value !== undefined) {
        element.innerText = parseFloat(value).toFixed(2);
    } else {
        console.warn(`‚ö†Ô∏è Element with ID '${id}' not found or value undefined`);
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤ Integer
function updateIntegerElement(id, value) {
    const el = document.getElementById(id);
    if (el) {
        el.innerText = parseInt(value, 10);
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ RUN/OFF
function updateStatusElement(id, value) {
    const el = document.getElementById(id);
    if (el) {
        const numericVal = parseFloat(value);
        el.textContent = numericValue > 10 ? "RUN" : "OFF";
    } else {
        console.warn(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö ${id} ‡πÉ‡∏ô DOM`);
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï GIF ‡∏û‡∏±‡∏î‡∏•‡∏°
function updateFanGif(id, value) {
    const gif = document.getElementById(id);
    if (gif) {
        gif.style.display = parseFloat(value) > 10 ? "block" : "none";
    }
}

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å MQTT
mqttClient.on("message", (topic, message) => {
    try {
        const data = JSON.parse(message.toString());
        console.log("üì© Received MQTT Data:", data);

        if (data.devs && Array.isArray(data.devs)) {
            data.devs.forEach(dev => {
                if (dev.d && Array.isArray(dev.d)) {
                    dev.d.forEach(item => {
                        if (item.m && item.v !== undefined) {
                            updateElement(item.m, item.v);  // ‡πÉ‡∏ä‡πâ item.m ‡πÄ‡∏õ‡πá‡∏ô id ‡πÅ‡∏•‡∏∞ item.v ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤
                        }
                    });
                }
            });
        }

        // ‚úÖ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤ ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡∏´‡∏•‡∏±‡∏Å‡πÜ:
        if (data.de && Array.isArray(data.de)) {
            data.de.forEach(item => {
                updateElement(item.m, item.value || item.v);
            });
        }

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ `d` ‡πÅ‡∏•‡∏∞ `m`
        if (data.dev && Array.isArray(data.dev)) {
            data.dev.forEach(device => {
                device.d.forEach(dItem => {
                    updateElement(d.m, d.v);
                });
            });
        }

        // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
        if (data.RA_H !== undefined) updateElement("RA_H", data.RA_H);
        if (data.Lev_Coil_T !== undefined) updateElement("Lev_Coil_T", data.Lev_Coil_T);
        if (data.SA_T !== undefined) updateElement("SA_T", data.SA_T);
        if (data.SA_H !== undefined) updateElement("SA_H", data.SA_H);
        if (data.OA_H !== undefined) updateElement("OA_H", data.OA_H);
        if (data.OA_T !== undefined) updateElement("OA_T", data.OA_T);
        if (data.DXVALVE !== undefined) updateElement("DXVALVE", data.DXVALVE);
        if (data.AC_SP_ZA !== undefined) updateElement("RAC_SP_ZA", data.AC_SP_ZA);
        if (data.AC_SP_EBM !== undefined) updateElement("AC_SP_EBM", data.AC_SP_EBM/65535);


        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï GIF Wheel
        if (data.Wheel !== undefined) {
            updateWheel(data.Wheel);
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï EMC UI
        if (data.EMC !== undefined) {
            updateEMCGUI(data.EMC);
        }

    } catch (error) {
        console.error("‚ùå Error parsing MQTT data:", error);
    }
});
function updateElement(id, value) {
    const el = document.getElementById(id);
    if (el && value !== undefined) {
        el.innerText = parseFloat(value).toFixed(2);
    } else {
        console.warn(`‚ö†Ô∏è Element with ID '${id}' not found or value undefined`);
    }
}

mqttClient.on("message", (topic, message) => {
    try {
        const data = JSON.parse(message.toString());
        console.log("üì© Received MQTT Data:", data);

        if (data.devs && Array.isArray(data.devs)) {
            data.devs.forEach(dev => {
                dev.d.forEach(item => {
                    if (item.m && item.v !== undefined) {
                        let val = item.m === "AC_SP_EBM" ? item.v / 65535 : item.v;
                        updateElement(item.m, val);
                        
                        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ RUN/OFF ‡∏ï‡∏≤‡∏° AC_SP_ZA ‡πÅ‡∏•‡∏∞ AC_SP_EBM
                        if (item.m === "AC_SP_ZA") updateStatusElement("sa_st", val);
                        if (item.m === "AC_SP_EBM") updateStatusElement("ebm_st", val);
                    }
                });
            });
        }
    } catch (error) {
        console.error("‚ùå Error parsing MQTT data:", error);
    }
});



// MQTT Error Handling
mqttClient.on("error", (error) => {
    console.error("‚ùå MQTT Error:", error);
});

mqttClient.on("close", function () {
    console.warn("‚ö†Ô∏è MQTT Disconnected! Reconnecting...");
});


</script>
</html>
