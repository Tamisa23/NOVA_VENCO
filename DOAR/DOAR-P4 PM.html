<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <meta charset="UTF-8"/>
    <meta name="viveport" content="width=device-width, initial-scale=1.0" />
    <title>Page Title</title>
    <link rel="stylesheet" href="/DOAR/DOAR-P4 PM.css" />
    <link rel="icon" type="image/x-icon" href="/image/HOME/LOGO VENCO .png">


  </head>
  <style>

    /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover */
    .hover-effect {
        transition: transform 0.3s ease-in-out;
    }
    
    .hover-effect:hover {
        transform: scale(1.1); /* ‡∏Ç‡∏¢‡∏≤‡∏¢ 10% */
    }
      </style>
  <body>


  <div class="GP">
    <a><img src="/image/DOAR/PM2.5/BG.jpg"></a>
    <a><img src="/image/DOAR/PM2.5/ST.png"></a>
  
    </div>
    
    


    <div class="GP">
      
     

        <div class="goodair">
          <a><img id="Filter_On" src="/image/DOAR/PM2.5/GIF/GIF-AIR-FILTER--PM.gif"></a>
          <a><img id="Filter_Off" src="/image/DOAR/PM2.5/GIF/BG-AIR FILTER.png"></a>  
        </div>
        <div class="goodair2">
          <a><img id="Filter_Image" src="/image/DOAR/PM2.5/Good AIR.png" width="1920" height="1080"></a>
        </div>
        
        <div class="PMgood">
            <a><img id="aqi_good" src="/image/DOAR/PM2.5/Good.png"></a>
        </div>
        <div class="PMmod">
            <a><img id="aqi_mod" src="/image/DOAR/PM2.5/Mod.png"></a>
        </div>
        <div class="PMbad">
            <a><img id="aqi_bad" src="/image/DOAR/PM2.5/Bad.png"></a>
        </div>
        <div class="smoke">
            <a href="#" onclick="toggleSmoke()"><img id="SmokeImg" class="hover-effect float" src="/image/DOAR/icon/smoke.png" width="235" height="230"></a>    
        </div>
        <div class="AR">
            <a href="#" onclick="toggleAQE()"><img id="AqeImg" class="hover-effect float" src="/image/DOAR/icon/ar.png" width="235" height="230"></a>    
        </div>

        <div class="home">
            <a href="/DOAR/DOAR-P1.html"><img src="/image/DOAR/P1/Not.png" width="328" height="129"></a>
        </div>
        <div class="EmerP2">
            <a href="#" onclick="toggleEMC()" ><img id="EMCImg" class="hover-effect float"  src="/image/DOAR/P2/BG-EMC.png" width="128" height="129"></a>
        </div>
          


  
    <div class="GPbox1">
      <div id="AQI_AC" class="box">10</div>
    </div>
    <div class="GPbox2">
      <div id="PM25" class="box">20</div>
    </div>
    <div class="GPbox3">
        <div id="PM10" class="box">10</div>
      </div>

    </div>
    <script>
     // ‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MQTT Broker
    const mqttClient = mqtt.connect("wss://2217876f209d4a73af014e541592ee16.s1.eu.hivemq.cloud:8884/mqtt", {
        username: "Venco",
        password: "12345678Venco",
        rejectUnauthorized: false
    });

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MQTT ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ Subscribe ‡πÑ‡∏õ‡∏ó‡∏µ‡πà `DOAR` ‡πÅ‡∏•‡∏∞ `DOAR/command`
  mqttClient.on("connect", function () {
      console.log("‚úÖ MQTT Connected!");
      
      mqttClient.subscribe("DOAR", function (err) {
          if (!err) console.log("‚úÖ Subscribed to DOAR");
      });
  
      mqttClient.subscribe("DOAR/command", function (err) {
          if (!err) console.log("‚úÖ Subscribed to DOAR/command");
      });
  });
  
     // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤ `commandData` ‡∏à‡∏≤‡∏Å localStorage ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  let commandData = JSON.parse(localStorage.getItem("commandData")) || {
      START: 0,
      A_M: 0,
      Wheel: 0,
      LTG: 0,
      EMC: 0,
      Mode: 0,
      set_sa: 0,
      set_sa2: 0,
      set_ea: 0,
      SA_SP: 0,
       DPT_SP: 0 ,
       Aqe : 0 ,
       Smoke: 0
  };
  
  // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ localStorage ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
  function saveCommandData() {
      localStorage.setItem("commandData", JSON.stringify(commandData));
  }
  
  
  function updateCommandAndSend(key, value) {
      commandData[key] = value; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô object
      saveCommandData(); // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage
      console.log(`üöÄ ‡∏™‡πà‡∏á MQTT: ${key} = ${value}`, commandData);
      
      // ‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ MQTT
      mqttClient.publish("DOAR/command", JSON.stringify(commandData));
  }
  
  let AqeState = 0;
// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ MQTT
function toggleAQE() {
    commandData.Aqe = commandData.Aqe === 0 ? 1 : 0;
      updateCommandAndSend("Aqe", commandData.Aqe);
      updateAqeUI(commandData.Aqe);
}

let SmokeState = 0;
function toggleSmoke() {
    commandData.Smoke = commandData.Smoke === 0 ? 1 : 0;
      updateCommandAndSend("Smoke", commandData.Smoke);
      updateSmokeUI(commandData.Smoke);
}

let EMCState = 0;
function toggleEMC() {
      commandData.EMC = commandData.EMC === 0 ? 1 : 0;
      updateCommandAndSend("EMC", commandData.EMC);
      updateEMCGUI(commandData.EMC);
  }

// ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤
function updateAqeUI(value) {
    document.getElementById("AqeImg").src = value === 1 ? "/image/DOAR/icon/AQE-ON.png" : "/image/DOAR/icon/ar.png";
}

function updateSmokeUI(value) {
    document.getElementById("SmokeImg").src = value === 1 ? "/image/DOAR/icon/N4-18.png" : "/image/DOAR/icon/smoke.png";
}

function updateEMCGUI(value) {
    document.getElementById("EMCImg").src = value === 1 ? "/image/DOAR/icon/EMC.png" : "/image/DOAR/P2/BG-EMC.png";
}

// ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Filter ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤
function updateFilter(value) {
    let imgFilterOn = document.getElementById("Filter_On");
    let imgFilterOff = document.getElementById("Filter_Off");

    if (!imgFilterOn || !imgFilterOff) {
        console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û Filter ‡πÉ‡∏ô DOM");
        return;
    }

    imgFilterOn.style.display = "none";
    imgFilterOff.style.display = "none";

    if (value === 1) {
        imgFilterOn.style.display = "block";  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î Filter
    } else {
        imgFilterOff.style.display = "block"; // ‚úÖ ‡∏õ‡∏¥‡∏î Filter
    }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
function updateElement(id, value) {
    let element = document.getElementById(id);
    if (element) {
        element.innerText = parseFloat(value).toFixed(2);
    }
}

// ‚úÖ ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å MQTT ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
mqttClient.on("message", function (topic, message) {
    try {
        let data = JSON.parse(message.toString());
        console.log(`üì© MQTT Data Received from ${topic}:`, data);

        if (topic === "DOAR") {
            if (data.Smoke !== undefined) {
                localStorage.setItem("Smoke", data.Smoke);
                updateSmokeUI(parseInt(data.Smoke, 10));
            }
            if (data.Aqe !== undefined) {
                localStorage.setItem("Aqe", data.Aqe);
                updateAqeUI(parseInt(data.Aqe, 10));
            }
            if (data.EMC !== undefined) {
                localStorage.setItem("EMC", data.EMC);
                updateEMCGUI(parseInt(data.EMC, 10));
            }
            if (data.Filter !== undefined) {
                localStorage.setItem("Filter", data.Filter);
                updateFilter(parseInt(data.Filter, 10));
            }
            if (data.PM10 !== undefined) updateElement("PM10", data.PM10);
            if (data.PM25 !== undefined) updateElement("PM25", data.PM25);
            if (data.AQI_AC !== undefined) updateElement("AQI_AC", data.AQI_AC);
}
    } catch (error) {
        console.error("‚ùå Error parsing MQTT message:", error);
    }
    });
    mqttClient.on("message", function (topic, message) {
      try {
          var data = JSON.parse(message.toString());
          console.log(`üì© Received MQTT Data from ${topic}:`, data);
  
          if (topic === "DOAR/command") {
              // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å MQTT ‡πÑ‡∏õ‡∏ó‡∏µ‡πà commandData
              Object.keys(data).forEach(key => {
                  if (commandData.hasOwnProperty(key)) {
                      commandData[key] = data[key];
                  }
              });
  
              saveCommandData(); // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á localStorage
  
              // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
              updateElement("SA_SP", commandData.SA_SP);
              updateElement("DPT_SP", commandData.DPT_SP);
              updateElement("set_sa", commandData.set_sa);
              updateElement("set_sa2", commandData.set_sa2);
              updateElement("set_ea", commandData.set_ea);
              updateStartStopUI(commandData.START);
              updateAutoManualUI(commandData.A_M);
              updateWheelUI(commandData.Wheel);
              updateLTGUI(commandData.LTG);
              updateEMCGUI(commandData.EMC);
              updateModeUI(commandData.Mode);
              updateAqeUI(commandData.Aqe);
              updateSmokeUI(commandData.Smoke);
              
          }
      } catch (error) {
          console.error("‚ùå Error parsing MQTT message:", error);
      }
  });


    function sendMQTT(topic, value) {
        if (mqttClient.connected) {
            let message = JSON.stringify({ [topic]: value });
            mqttClient.publish("DOAR/command", message);
            console.log(`‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ MQTT: ${topic} = ${value}`);
        } else {
            console.warn(`‚ö†Ô∏è MQTT ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ ${topic} ‡πÑ‡∏î‡πâ`);
        }
    }

    function updateAqeUI(value) {
        document.getElementById("AqeImg").src = value === 1 ? "/image/DOAR/icon/AQE-ON.png" : "/image/DOAR/icon/ar.png";
    }

    function updateSmokeUI(value) {
        document.getElementById("SmokeImg").src = value === 1 ? "/image/DOAR/icon/N4-18.png" : "/image/DOAR/icon/smoke.png";
    }

    function updateEMCGUI(value) {
        document.getElementById("EMCImg").src = value === 1 ? "/image/DOAR/icon/EMC.png" : "/image/DOAR/P2/BG-EMC.png";
    }

    function updateAQI(value) {
        let imgGood = document.getElementById("aqi_good");
        let imgMod = document.getElementById("aqi_mod");
        let imgBad = document.getElementById("aqi_bad");

        imgGood.style.display = "none";
        imgMod.style.display = "none";
        imgBad.style.display = "none";

        if (value >= 0 && value <= 1) {
            imgGood.style.display = "block";
        } else if (value === 2) {
            imgMod.style.display = "block";
        } else {
            imgBad.style.display = "block";
        }
    }
    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Filter ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤ MQTT
function updateFilter(FilterValue) {
    let imgFilterOn = document.getElementById("Filter_On");
    let imgFilterOff = document.getElementById("Filter_Off");

    if (!imgFilterOn || !imgFilterOff) {
        console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û Filter ‡πÉ‡∏ô DOM");
        return;
    }

    console.log(`üîÑ ‡∏Ñ‡πà‡∏≤ Filter ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å MQTT: ${FilterValue}`);

    // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô
    imgFilterOn.style.display = "none";
    imgFilterOff.style.display = "none";

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤ Filter ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å MQTT
    if (parseInt(FilterValue) === 1) {
        imgFilterOn.style.display = "block";  // ‡πÅ‡∏™‡∏î‡∏á Filter On
        console.log("‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ Filter ON");
    } else {
        imgFilterOff.style.display = "block"; // ‡πÅ‡∏™‡∏î‡∏á Filter Off
        console.log("‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ Filter OFF");
    }
}

    function updateElement(id, value) {
        let element = document.getElementById(id);
        if (element) {
            element.innerText = parseFloat(value).toFixed(2);
        }
    }

    mqttClient.on("message", function (topic, message) {
        try {
            let data = JSON.parse(message.toString());
            console.log(`üì© MQTT Data Received from ${topic}:`, data);

            if (topic === "DOAR") {
                if (data.set_ea !== undefined) updateElement("set_ea", data.set_ea);
                if (data.set_sa !== undefined) updateElement("set_sa", data.set_sa);
                if (data.set_ebm !== undefined) updateElement("set_ebm", data.set_ebm);
                if (data.max_ea !== undefined) updateElement("max_ea", data.max_ea);
                if (data.max_sa !== undefined) updateElement("max_sa", data.max_sa);
                if (data.max_ebm !== undefined) updateElement("max_ebm", data.max_ebm);
                if (data.Smoke !== undefined) updateSmokeUI(parseInt(data.Smoke, 10));
                if (data.Aqe !== undefined) updateAqeUI(parseInt(data.Aqe, 10));
                if (data.EMC !== undefined) updateEMCGUI(parseInt(data.EMC, 10));
                if (data.AQI !== undefined) updateAQI(parseInt(data.AQI, 10));
                if (data.PM10 !== undefined) updateElement("PM10", data.PM10);
                if (data.PM25 !== undefined) updateElement("PM25", data.PM25);
                if (data.AQI_AC !== undefined) updateElement("AQI_AC", data.AQI_AC);
                if (data.Filter !== undefined) updateFilter(data.Filter);  // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤ Filter
                if (data.wheelState !== undefined) updateWheelUI(data.wheelState);

                 // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï START/STOP ‡∏à‡∏≤‡∏Å `cmd`
        if (topic === "DOAR" && data.cmd !== undefined && Array.isArray(data.cmd)) {
            let cmdValue = parseInt(data.cmd[0], 10);
            console.log("‚úÖ CMD Value Received:", cmdValue);
            if (!isNaN(cmdValue) && (cmdValue === 0 || cmdValue === 1)) {
                updateStartStopUI(cmdValue);
            }
        }

        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Auto/Manual ‡∏à‡∏≤‡∏Å `A_M`
        if (topic === "DOAR" && data.A_M !== undefined && Array.isArray(data.A_M)) {
            let A_MValue = parseInt(data.A_M[0], 10);
            console.log("‚úÖ AUTO/MANUAL Value Received:", A_MValue);
            if (!isNaN(A_MValue) && (A_MValue === 0 || A_MValue === 1)) {
                updateAutoManualUI(A_MValue);
            }
        }}

        } catch (error) {
            console.error("‚ùå Error parsing MQTT message:", error);
        }
    });
    </script>

  </body>
</html>
