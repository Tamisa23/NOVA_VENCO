<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viveport" content="width=device-width, initial-scale=1.0" />
    <title>Page Title</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link rel="stylesheet" href="/DOAR/DOAR-P4.css" />
  </head>
  <style>

    /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover */
    .hover-effect {
        transition: transform 0.3s ease-in-out;
    }
    
    .hover-effect:hover {
        transform: scale(1.1); /* ‡∏Ç‡∏¢‡∏≤‡∏¢ 10% */
    }
      </style>
  <body>

  <div class="GP">
    <a><img src="/image/DOAR/P4/BG.jpg"></a>
  </div>

<div class="GP">
  <div class="Next">
    <a href="/DOAR/DOAR-P5.html"><img src="/image/DOAR/P4/Next.png" width="159" height="175"></a>
</div>
  <div class="GPbox1">
    <div id="set_ebm" class="box">100</div>
    <div class="GPbox4">
      <div id="max_ebm" class="box">2000</div>
    </div>
  </div>
<div class="GPbox2">
  <div  id="set_sa" class="box">200</div>
  <div class="GPbox5">
    <div id="max_sa" class="box">3000</div>
  </div>
</div>
<div class="GPbox3">
  <div id="set_ea" class="box">300</div>
  <div class="GPbox6">
    <div id="max_ea" class="box">4000</div>
  </div>
</div>
</div>


<div class="GP">
  <div class="start">
      <a href="#" onclick="toggleStartStop('start')">
          <img id="startImg" class="hover-effect float" src="/image/DOAR/P4/BG-START.png" width="212" height="217">
      </a>
  </div>
  <div class="stop">
      <a href="#" onclick="toggleStartStop('stop')">
          <img id="stopImg" class="hover-effect float" src="/image/DOAR/P4/BG-STOP.png" width="212" height="217">
      </a>
  </div>
  <div class="wheel">
    <a href="#"><img src="/image/DOAR/P4/BG-WHEEL p4.png" width="212" height="217"></a>
  </div>
  <div class="lighting">
    <a href="#"><img src="/image/DOAR/P4/BG-LIGHTING.png" width="212" height="217"></a>
  </div>

  <div class="auto">
    <a href="#" onclick="toggleAutoManual('Auto')">
        <img id="autoImg" class="hover-effect float" src="/image/DOAR/icon/BG-AUTO.png" width="212" height="217">
    </a>
</div>
<div class="manual">
    <a href="#" onclick="toggleAutoManual('Manual')">
        <img id="manualImg" class="hover-effect float" src="/image/DOAR/icon/BG-MANUAL.png" width="212" height="217">
    </a>
</div>

  <div class="EmerP2">
    <a href="#"><img src="/image/DOAR/P2/BG-EMC.png" width="128" height="129"></a>
  </div>
  <div class="testsmoke">
    <a href="#"><img src="/image/DOAR/P4/BG-Test Smoke-31.png" width="128" height="129"></a>
  </div>
  <div class="exhaust">
    <a href="#"><img src="/image/DOAR/P4/BG-EXHAUST.png" width="128" height="129"></a>
  </div>
  <div class="fresh">
    <a href="#"><img src="/image/DOAR/P4/BG-FRESH AIR.png" width="128" height="129"></a>
  </div>
  <div class="Normal">
    <a href="#"><img src="/image/DOAR/P4/BG-NORMAL.png" width="128" height="129"></a>
  </div>
  
  <div class="home">
    <a href="/DOAR/DOAR-P1.html"><img src="/image/DOAR/P1/Not.png" width="328" height="129"></a>
  </div>

</div>

<script>
  // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MQTT Broker ‡∏ú‡πà‡∏≤‡∏ô WebSockets
const mqttClient = mqtt.connect("wss://2217876f209d4a73af014e541592ee16.s1.eu.hivemq.cloud:8884/mqtt", {
    username: "Venco",
    password: "12345678Venco",
    rejectUnauthorized: false 
});

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MQTT ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ Subscribe ‡πÑ‡∏õ‡∏ó‡∏µ‡πà `DOAR` ‡πÅ‡∏•‡∏∞ `DOAR/command`
mqttClient.on("connect", function () {
    console.log("‚úÖ MQTT Connected!");
    
    mqttClient.subscribe("DOAR", function (err) {
        if (!err) console.log("‚úÖ Subscribed to DOAR");
    });

    mqttClient.subscribe("DOAR/command", function (err) {
        if (!err) console.log("‚úÖ Subscribed to DOAR/command");
    });
});

// üì© ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å MQTT ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤
mqttClient.on("message", function (topic, message) {
    try {
        var data = JSON.parse(message.toString());
        console.log(`üì© Received MQTT Data from ${topic}:`, data);

        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
        if (data.set_ea !== undefined) updateElement("set_ea", data.set_ea);
        if (data.set_sa !== undefined) updateElement("set_sa", data.set_sa);
        if (data.set_ebm !== undefined) updateElement("set_ebm", data.set_ebm);
        if (data.max_ea !== undefined) updateElement("max_ea", data.max_ea);
        if (data.max_sa !== undefined) updateElement("max_sa", data.max_sa);
        if (data.max_ebm !== undefined) updateElement("max_ebm", data.max_ebm);

        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï START/STOP ‡∏à‡∏≤‡∏Å `cmd`
        if (topic === "DOAR" && data.cmd !== undefined && Array.isArray(data.cmd)) {
            let cmdValue = parseInt(data.cmd[0], 10);
            console.log("‚úÖ CMD Value Received:", cmdValue);
            if (!isNaN(cmdValue) && (cmdValue === 0 || cmdValue === 1)) {
                updateStartStopUI(cmdValue);
            }
        }

        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Auto/Manual ‡∏à‡∏≤‡∏Å `A_M`
        if (topic === "DOAR" && data.A_M !== undefined && Array.isArray(data.A_M)) {
            let A_MValue = parseInt(data.A_M[0], 10);
            console.log("‚úÖ AUTO/MANUAL Value Received:", A_MValue);
            if (!isNaN(A_MValue) && (A_MValue === 0 || A_MValue === 1)) {
                updateAutoManualUI(A_MValue);
            }
        }

    } catch (error) {
        console.error("‚ùå Error parsing MQTT message:", error);
    }
});

// üìå ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° START/STOP ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å `cmd`
function updateStartStopUI(value) {
    let startImg = document.getElementById("startImg");
    let stopImg = document.getElementById("stopImg");

    if (startImg && stopImg) {
        console.log("üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û UI ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤ CMD:", value);
        if (value === 1) {
            startImg.src = "/image/DOAR/icon/N4-19.png"; 
            stopImg.src = "/image/DOAR/P4/BG-STOP.png";
        } else {
            stopImg.src = "/image/DOAR/icon/N4-20.png"; 
            startImg.src = "/image/DOAR/P4/BG-START.png"; 
        }
    } else {
        console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö startImg ‡∏´‡∏£‡∏∑‡∏≠ stopImg ‡πÉ‡∏ô DOM");
    }
}

// üìå ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° Auto/Manual ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å `A_M`
function updateAutoManualUI(value) {
    let autoImg = document.getElementById("autoImg");
    let manualImg = document.getElementById("manualImg");

    if (autoImg && manualImg) {
        console.log("üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏´‡∏°‡∏î AUTO/MANUAL ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤:", value);
        if (value === 1) {
            autoImg.src = "/image/DOAR/icon/N4-23.png"; 
            manualImg.src = "/image/DOAR/icon/BG-MANUAL.png";
        } else {
            manualImg.src = "/image/DOAR/icon/N4-24.png"; 
            autoImg.src = "/image/DOAR/icon/BG-AUTO.png";
        }
    } else {
        console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö autoImg ‡∏´‡∏£‡∏∑‡∏≠ manualImg ‡πÉ‡∏ô DOM");
    }
}

// üìå ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ MQTT ‡πÑ‡∏õ‡∏ó‡∏µ‡πà `DOAR/command` ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î START ‡∏´‡∏£‡∏∑‡∏≠ STOP
function toggleStartStop(action) {
    let startImg = document.getElementById("startImg");
    let stopImg = document.getElementById("stopImg");
    
    if (action === "start") {
        mqttClient.publish("DOAR/command", JSON.stringify({ START: 1 }));
        updateStartStopUI(1);
    } else if (action === "stop") {
        mqttClient.publish("DOAR/command", JSON.stringify({ START: 0 }));
        updateStartStopUI(0);
    }
}

// üìå ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ MQTT ‡πÑ‡∏õ‡∏ó‡∏µ‡πà `DOAR/command` ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î AUTO ‡∏´‡∏£‡∏∑‡∏≠ MANUAL
function toggleAutoManual(action) {
    let autoImg = document.getElementById("autoImg");
    let manualImg = document.getElementById("manualImg");

    if (action === "Auto") {
        console.log("üöÄ ‡∏™‡πà‡∏á MQTT: A_M = 1 (AUTO MODE)");
        mqttClient.publish("DOAR/command", JSON.stringify({ A_M: 1 }));
        updateAutoManualUI(1);
    } else if (action === "Manual") {
        console.log("üöÄ ‡∏™‡πà‡∏á MQTT: A_M = 0 (MANUAL MODE)");
        mqttClient.publish("DOAR/command", JSON.stringify({ A_M: 0 }));
        updateAutoManualUI(0);
    }
}
// üìå ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô HTML
function updateElement(id, value) {
    let element = document.getElementById(id);
    if (element && value !== undefined) {
        element.innerText = parseFloat(value); 
    }
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
document.addEventListener("DOMContentLoaded", function() {
    console.log("üìå DOM Loaded, Ready to receive MQTT messages.");
});

// ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏≠‡∏á MQTT
mqttClient.on("error", function (error) {
    console.error("‚ùå MQTT Error:", error);
});

mqttClient.on("close", function () {
    console.warn("‚ö†Ô∏è MQTT Disconnected! Reconnecting...");
});



</script>
  </body>
</html>
